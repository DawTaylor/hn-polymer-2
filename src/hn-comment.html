<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="simple-element-mixin.html">
<link rel="import" href="simple-list-mixin.html">

<dom-module id="hn-comment">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
      }

      a {
        color: #000;
        cursor: pointer;
      }

      .toggle {
        cursor: pointer;
        user-select: none;
      }

      .header {
        padding: 8px 0;
      }

      .header > * {
        margin-right: .25rem;
        color: var(--detail-font-color);
      }

      .comment {
        border-bottom: var(--separator-border);
      }

      .comment > p {
        overflow-wrap: break-word;
      }

      .comment > p:first-of-type {
        margin-top: 0;
      }

      .comments {
        padding-left: 8px;
      }
    </style>
    <div class="header">
      <a class="toggle" id="toggle">[-]</a>
      <a class="user" id="user"></a>
      <a id="time"></a>
    </div>
    <div id="comment" class="comment"></div>
    <div id="comments" class="comments"></div>
  </template>

  <template id="itemTemplate"><hn-comment id="item"></hn-comment></template>

  <script>
  (function() {

    const ELEMENT_NAME = 'hn-comment';

    const itemTemplate = Polymer.DomModule.import(ELEMENT_NAME, '#itemTemplate');

    class HnComment extends Polymer.SimpleListMixin(Polymer.SimpleElementMixin(HTMLElement)) {

      static get observedAttributes() { return ['comment']; }

      static get template() {
        return Polymer.DomModule.import(ELEMENT_NAME, 'template');
      }

      constructor() {
        super();
        this._collapsed = false;
        this._commentThreadSize = 0;
      }

      _attachDom(dom) {
        dom.$.toggle.addEventListener('click', (e) => this._toggleCollapse(e));
        super._attachDom(dom);
      }

      _propertiesChanged(props) {
        const comment = props.comment;
        const comments = comment.comments;
        this._dataToDom({
          user: {href: `/user/${comment.user}`, textContent: `${comment.user}`},
          time: {href: `/item/${comment.id}`, textContent: `${comment.time_ago}`},
          comment: {innerHTML: comment.content},

        });
        this._renderList(this.$.comments, comments, itemTemplate,
          (n, d) => { return {item: {comment: d}}}
        );
      }

      _toggleCollapse() {
        this._collapsed = !this._collapsed;
        if (!this._commentThreadSize) {
          this._commentThreadSize = this._calculateCommentThreadSize(this.comment);
        }
        this._dataToDom({
          toggle: {textContent: this._collapsed ? `[+${this._commentThreadSize}]` : '[â€“]'},
          comment: {attributes: {hidden: this._collapsed}}
        });
      }

      _calculateCommentThreadSize(comment) {
        let threadSize = 0;
        let flat = (comment) => {
          threadSize++;
          comment.comments.forEach(flat);
        };
        flat(comment);
        return threadSize;
      }

    }

    customElements.define(ELEMENT_NAME, HnComment);

  })();
  </script>
</dom-module>
